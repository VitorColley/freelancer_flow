<% content_for :title, "Invoice" %>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h1 class="h4 mb-1">Invoice</h1>
            <p class="text-muted small mb-0">
              Issued <%= time_ago_in_words(@invoice.created_at) %> ago
            </p>
          </div>

          <span class="badge
            <%= @invoice.status == "paid" ? "bg-success" : "bg-secondary" %>">
            <%= @invoice.status.capitalize %>
          </span>
        </div>

        <hr>

        <h6 class="text-muted">Project</h6>
        <p class="fw-semibold"><%= @invoice.project.title %></p>

        <h6 class="text-muted mt-3">Client</h6>
        <p>
          <%= @invoice.project.client.name.presence ||
              @invoice.project.client.email_address %>
        </p>

        <% accepted_proposal =
            @invoice.project.proposals.find_by(status: "accepted") %>

        <% if accepted_proposal %>
          <h6 class="text-muted mt-3">Freelancer</h6>
          <p>
            <%= accepted_proposal.freelancer.name.presence ||
                accepted_proposal.freelancer.email_address %>
          </p>
        <% end %>

        <hr>

        <div class="d-flex justify-content-between align-items-center">
          <strong>Total</strong>
          <span class="fs-4 fw-semibold">
            €<%= number_to_currency(@invoice.amount, unit: "") %>
          </span>
        </div>

        <% if current_user == @invoice.project.client &&
              @invoice.status == "pending" %>
          <div class="mt-4">
            <%= link_to "Pay invoice",
                        "#",
                        class: "btn btn-success w-100 disabled" %>
            <small class="text-muted d-block mt-2">
              Payment integration coming next.
            </small>
          </div>
        <% end %>

        <% if current_user == @invoice.project.client &&
              @invoice.status == "unpaid" %>

          <%= button_to "Pay invoice",
                        checkout_invoice_path(@invoice),
                        method: :post,
                        data: { turbo: false },
                        class: "btn btn-success w-100 mt-4" %>

        <% elsif @invoice.status == "paid" %>

          <div class="alert alert-success mt-4">
            Invoice has been paid.
          </div>

        <% end %>
      </div>
    </div>

    <%= link_to "← Back to invoices",
                invoices_path,
                class: "btn btn-link px-0 mt-3" %>
  </div>
</div>
